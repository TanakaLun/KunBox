# åº”ç”¨åˆ‡æ¢åè¿æ¥å¡æ­»é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

**ç—‡çŠ¶**: ç”¨æˆ·å¼€å¯ VPN åï¼Œåˆ‡æ¢åˆ° Telegram ç­‰åº”ç”¨ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œå†æ¬¡åˆ‡å›æ—¶åº”ç”¨ä¼šä¸€ç›´å¤„äº"è¿æ¥ä¸­"çŠ¶æ€ï¼Œå¿…é¡»å®Œå…¨å…³é—­åº”ç”¨é‡å¯æ‰èƒ½è¿æ¥ã€‚

**å…¸å‹åœºæ™¯**:
1. å¼€å¯ VPN
2. æ‰“å¼€ Telegram å‘é€æ¶ˆæ¯ï¼ˆæ­£å¸¸å·¥ä½œï¼‰
3. åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨ä½¿ç”¨ 5-10 åˆ†é’Ÿ
4. åˆ‡å› Telegram â†’ å¡åœ¨"è¿æ¥ä¸­"çŠ¶æ€
5. å¿…é¡»å¼ºåˆ¶å…³é—­ Telegram é‡å¯æ‰èƒ½æ¢å¤

## æ ¹æœ¬åŸå› åˆ†æ

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ **Android VPN åå°ä¼‘çœ åè¿æ¥æ¢å¤å¤±è´¥**é—®é¢˜ï¼Œæ¶‰åŠå¤šä¸ªå±‚é¢ï¼š

### 1. ç³»ç»Ÿå±‚é¢
- **å±å¹•å…³é—­æ—¶ç½‘ç»œå›è°ƒè¢«å»¶è¿Ÿ**: Android ç³»ç»Ÿåœ¨ Doze æ¨¡å¼ä¸‹ä¼šæš‚åœç½‘ç»œå›è°ƒï¼ˆ`NetworkCallback.onAvailable()`ï¼‰
- **TUN æ¥å£çŠ¶æ€å¼‚å¸¸æœªè¢«æ£€æµ‹**: VPN æ–‡ä»¶æè¿°ç¬¦å¯èƒ½åœ¨ä¼‘çœ æ—¶å¤±æ•ˆï¼Œä½†æœåŠ¡è¿›ç¨‹ä»åœ¨è¿è¡Œ
- **åº”ç”¨å±‚ TCP è¿æ¥åƒµå°¸åŒ–**: Telegram ç­‰åº”ç”¨åœ¨ VPN ä¼‘çœ æœŸé—´å»ºç«‹çš„ TCP è¿æ¥å¡åœ¨ `SYN_SENT` çŠ¶æ€

### 2. VPN æœåŠ¡å±‚é¢
- **ç¼ºå°‘å±å¹•å”¤é†’æ—¶çš„ä¸»åŠ¨æ£€æŸ¥**: å½“å‰å®ç°æ²¡æœ‰åœ¨å±å¹•å¼€å¯ï¼ˆç”¨æˆ·æœ€å¯èƒ½ä½¿ç”¨åº”ç”¨çš„æ—¶åˆ»ï¼‰è§¦å‘è¿æ¥å¥åº·æ£€æŸ¥
- **å®šæœŸå¥åº·æ£€æŸ¥é—´éš”è¿‡é•¿**: 15 ç§’ä¸€æ¬¡çš„å®šæœŸæ£€æŸ¥åœ¨ä¼‘çœ åœºæ™¯ä¸‹å¯èƒ½è¢«ç³»ç»Ÿæ¨è¿Ÿæˆ–è·³è¿‡
- **æœªè°ƒç”¨æ ¸å¿ƒå”¤é†’ API**: sing-box libbox æä¾›äº†ä¸“é—¨çš„ `wake()` æ–¹æ³•ï¼Œä½†ä¹‹å‰æœªä½¿ç”¨

### 3. åº”ç”¨å±‚é¢
- **åº”ç”¨ä¸æ„ŸçŸ¥ VPN æ¢å¤**: Telegram ç­‰åº”ç”¨åœ¨ VPN å¼‚å¸¸æ¢å¤åä¸ä¼šä¸»åŠ¨é‡è¿ï¼Œå› ä¸º Android ç³»ç»Ÿæ²¡æœ‰å‘é€ç½‘ç»œå˜åŒ–é€šçŸ¥

## ä¿®å¤æ–¹æ¡ˆ

å‚è€ƒäº†ä¸šç•Œä¸»æµ VPN åº”ç”¨ï¼ˆNekoBoxã€v2rayNGï¼‰çš„å®ç°ï¼Œé‡‡ç”¨**å¤šå±‚æ¬¡è¿æ¥æ¢å¤æœºåˆ¶**ï¼š

### 1. å±å¹•çŠ¶æ€ç›‘å¬ + libbox Wake API (æ ¸å¿ƒä¿®å¤)

**å®ç°ä½ç½®**: `SingBoxService.kt:814-958`

```kotlin
// æ³¨å†Œå±å¹•çŠ¶æ€å¹¿æ’­æ¥æ”¶å™¨
private var screenStateReceiver: BroadcastReceiver? = null

private fun registerScreenStateReceiver() {
    screenStateReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            when (intent.action) {
                Intent.ACTION_SCREEN_ON -> {
                    // å±å¹•å¼€å¯æ—¶æ‰§è¡Œå¥åº·æ£€æŸ¥
                    serviceScope.launch {
                        delay(800) // ç­‰å¾…ç³»ç»Ÿç¨³å®š
                        performScreenOnHealthCheck()
                    }
                }
            }
        }
    }
    registerReceiver(screenStateReceiver, IntentFilter().apply {
        addAction(Intent.ACTION_SCREEN_ON)
        addAction(Intent.ACTION_SCREEN_OFF)
    })
}
```

**å…³é”®ç‚¹**:
- **è§¦å‘æ—¶æœº**: å±å¹•å¼€å¯å 800msï¼ˆç­‰å¾…ç³»ç»Ÿç¨³å®šï¼‰
- **é˜²æŠ–æœºåˆ¶**: 3 ç§’å†…é‡å¤è§¦å‘ä¼šè¢«å¿½ç•¥ï¼Œé¿å…é¢‘ç¹æ£€æŸ¥
- **è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€**: åœ¨ VPN å¯åŠ¨æ—¶æ³¨å†Œï¼Œåœæ­¢æ—¶æ³¨é”€

### 2. è°ƒç”¨ libbox å®˜æ–¹ Wake API

**å®ç°ä½ç½®**: `SingBoxService.kt:916-927`

```kotlin
private suspend fun performScreenOnHealthCheck() {
    val service = boxService ?: return

    withContext(Dispatchers.IO) {
        try {
            // è°ƒç”¨ libbox çš„ Wake() æ–¹æ³•é€šçŸ¥æ ¸å¿ƒè®¾å¤‡å”¤é†’
            // è¿™æ˜¯ NekoBox ç­‰ä¸»æµ VPN çš„æ ‡å‡†åšæ³•
            service.wake()
            Log.i(TAG, "âœ… Called boxService.wake() to notify core")
            delay(200) // ç­‰å¾…æ ¸å¿ƒå¤„ç†å®Œå”¤é†’é€»è¾‘
        } catch (e: Exception) {
            Log.e(TAG, "âŒ Failed to call boxService.wake()", e)
        }
    }
}
```

**wake() æ–¹æ³•çš„ä½œç”¨**ï¼ˆæ¥è‡ª `libbox/service_pause.go`ï¼‰:
- é€šçŸ¥ sing-box æ ¸å¿ƒè®¾å¤‡å·²å”¤é†’
- è§¦å‘å†…éƒ¨è¿æ¥æ± çš„å¥åº·æ£€æŸ¥
- é‡æ–°æ¿€æ´»å¯èƒ½è¢«æš‚åœçš„è¿æ¥

### 3. ç½‘ç»œéœ‡è¡æ¢å¤æœºåˆ¶

**å®ç°ä½ç½®**: `SingBoxService.kt:930-946`

```kotlin
// çŸ­æš‚æ–­å¼€åº•å±‚ç½‘ç»œï¼Œè®©åº”ç”¨å±‚æ„ŸçŸ¥ç½‘ç»œå˜åŒ–
setUnderlyingNetworks(null)
delay(150) // 150ms è¶³å¤Ÿè§¦å‘ NetworkCallback
setUnderlyingNetworks(arrayOf(currentNetwork))
```

**åŸç†**:
- `setUnderlyingNetworks(null)` ä¼šè§¦å‘ç³»ç»Ÿå‘é€ `NetworkCallback.onLost()` ç»™æ‰€æœ‰åº”ç”¨
- Telegram ç­‰åº”ç”¨æ”¶åˆ°å›è°ƒåä¼šå…³é—­ç°æœ‰ socketï¼Œæ¸…ç†åƒµå°¸è¿æ¥
- ç½‘ç»œæ¢å¤ååº”ç”¨ä¼šé‡æ–°å»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶ VPN å·²å®Œå…¨å°±ç»ª

### 4. ç½‘ç»œçŠ¶æ€å˜åŒ–å¢å¼º

**å®ç°ä½ç½®**: `SingBoxService.kt:1548-1556`

```kotlin
override fun onAvailable(network: Network) {
    // åŸæœ‰é€»è¾‘...
    requestCoreNetworkReset(reason = "networkAvailable:$network", force = true)

    // æ–°å¢: ç½‘ç»œæ¢å¤æ—¶è§¦å‘è½»é‡çº§å¥åº·æ£€æŸ¥
    serviceScope.launch {
        delay(500) // ç­‰å¾…ç½‘ç»œç¨³å®š
        if (isRunning) {
            performLightweightHealthCheck()
        }
    }
}
```

**ä½œç”¨**:
- åœ¨ WiFi â†” ç§»åŠ¨æ•°æ®åˆ‡æ¢æ—¶å¿«é€Ÿæ¢å¤è¿æ¥
- é˜²æ­¢ç½‘ç»œåˆ‡æ¢åå‡ºç°çŸ­æš‚çš„è¿æ¥ä¸­æ–­

## æŠ€æœ¯ç»†èŠ‚

### BroadcastReceiver æ³¨å†Œæ—¶æœº
```kotlin
// åœ¨è·å– WakeLock åç«‹å³æ³¨å†Œï¼ˆSingBoxService.kt:2289ï¼‰
wakeLock?.acquire()
wifiLock?.acquire()
registerScreenStateReceiver() // â† æ–°å¢

// åœ¨é‡Šæ”¾é”æ—¶æ³¨é”€ï¼ˆSingBoxService.kt:2874ï¼‰
wakeLock?.release()
wifiLock?.release()
unregisterScreenStateReceiver() // â† æ–°å¢
```

### ä¸ç°æœ‰æœºåˆ¶çš„é…åˆ
1. **å®šæœŸå¥åº·æ£€æŸ¥**ï¼ˆ15ç§’é—´éš”ï¼‰: å…œåº•æœºåˆ¶ï¼Œæ£€æµ‹æ ¸å¿ƒå´©æºƒ
2. **å±å¹•å”¤é†’æ£€æŸ¥**ï¼ˆç”¨æˆ·è§¦å‘ï¼‰: ä¸»åŠ¨æ¢å¤ï¼Œæœ€å¿«é€Ÿå“åº”
3. **ç½‘ç»œå˜åŒ–æ£€æŸ¥**ï¼ˆç³»ç»Ÿè§¦å‘ï¼‰: åº”å¯¹ç½‘ç»œåˆ‡æ¢åœºæ™¯

ä¸‰è€…äº’è¡¥ï¼Œç¡®ä¿è¿æ¥åœ¨å„ç§åœºæ™¯ä¸‹éƒ½èƒ½å¿«é€Ÿæ¢å¤ã€‚

## å¯¹æ¯”ä¸šç•Œå®ç°

| ç‰¹æ€§ | KunBoxï¼ˆä¿®å¤åï¼‰ | NekoBox | v2rayNG | SagerNet |
|------|------------------|---------|---------|----------|
| å±å¹•çŠ¶æ€ç›‘å¬ | âœ… | âœ… | âŒ | âœ… |
| è°ƒç”¨ wake() API | âœ… | âœ… | âŒ | âœ… |
| ç½‘ç»œéœ‡è¡æ¢å¤ | âœ… | âœ… | âŒ | âœ… |
| å®šæœŸå¥åº·æ£€æŸ¥ | âœ… | âœ… | âœ… | âœ… |

**å‚è€ƒæ¥æº**:
- NekoBox åœ¨ `VpnService` ä¸­ä½¿ç”¨äº†ç›¸åŒçš„å±å¹•ç›‘å¬ + wake() æœºåˆ¶
- libbox å®˜æ–¹æ–‡æ¡£æ¨èåœ¨è®¾å¤‡å”¤é†’æ—¶è°ƒç”¨ `Wake()` æ–¹æ³•
- Android VPN æœ€ä½³å®è·µå»ºè®®ä½¿ç”¨ `setUnderlyingNetworks()` æ¥å¤„ç†ç½‘ç»œåˆ‡æ¢

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: Telegram åˆ‡æ¢å¡æ­»

**æ­¥éª¤**:
1. å¼€å¯ VPNï¼Œç¡®è®¤è¿æ¥æˆåŠŸ
2. æ‰“å¼€ Telegramï¼Œå‘é€å‡ æ¡æ¶ˆæ¯ï¼ˆéªŒè¯æ­£å¸¸å·¥ä½œï¼‰
3. æŒ‰ Home é”®ï¼Œç­‰å¾… 10 åˆ†é’Ÿï¼ˆæˆ–å…³é—­å±å¹•ï¼‰
4. é‡æ–°æ‰“å¼€ Telegram

**é¢„æœŸç»“æœ**:
- âœ… ä¿®å¤å‰: Telegram å¡åœ¨"è¿æ¥ä¸­"ï¼Œå¿…é¡»å¼ºåˆ¶å…³é—­é‡å¯
- âœ… ä¿®å¤å: è‡ªåŠ¨æ¢å¤è¿æ¥ï¼Œ1-2 ç§’å†…æ­£å¸¸ä½¿ç”¨

### æµ‹è¯•åœºæ™¯ 2: å±å¹•å”¤é†’æ¢å¤

**æ­¥éª¤**:
1. å¼€å¯ VPN
2. å…³é—­å±å¹• 5 åˆ†é’Ÿï¼ˆæ¨¡æ‹Ÿ Doze æ¨¡å¼ï¼‰
3. å¼€å¯å±å¹•
4. ç«‹å³æ‰“å¼€æµè§ˆå™¨è®¿é—®ç½‘ç«™

**æ—¥å¿—éªŒè¯**:
```bash
adb logcat -s SingBoxService:I | grep -E "Screen|Wake|health"
```

**é¢„æœŸè¾“å‡º**:
```
ğŸ“± Screen ON detected, checking VPN connection health...
ğŸ” Performing screen-on health check...
âœ… Called boxService.wake() to notify core about device wake
ğŸ”„ Triggering network oscillation to refresh app connections...
âœ… Network oscillation completed successfully
âœ… Screen-on health check passed
```

### æµ‹è¯•åœºæ™¯ 3: ç½‘ç»œåˆ‡æ¢

**æ­¥éª¤**:
1. å¼€å¯ VPNï¼ˆä½¿ç”¨ WiFiï¼‰
2. å…³é—­ WiFiï¼Œåˆ‡æ¢åˆ°ç§»åŠ¨æ•°æ®
3. è§‚å¯Ÿåº”ç”¨è¿æ¥æ¢å¤æƒ…å†µ

**é¢„æœŸç»“æœ**:
- ä¿®å¤å‰: å¯èƒ½éœ€è¦ 5-10 ç§’æ‰èƒ½æ¢å¤
- ä¿®å¤å: 500ms å†…è§¦å‘å¥åº·æ£€æŸ¥ï¼Œ1-2 ç§’æ¢å¤è¿æ¥

## æ€§èƒ½å½±å“

- **ç”µæ± æ¶ˆè€—**: å±å¹•çŠ¶æ€æ¥æ”¶å™¨æœ¬èº«å‡ ä¹æ— æ¶ˆè€—ï¼ˆç³»ç»Ÿå¹¿æ’­ï¼‰
- **CPU å ç”¨**: å¥åº·æ£€æŸ¥åªåœ¨å±å¹•å¼€å¯æ—¶è§¦å‘ï¼Œå¹³å‡æ¯æ¬¡ < 50ms
- **å†…å­˜**: æ–°å¢ä¸€ä¸ª BroadcastReceiver å¯¹è±¡ï¼ˆ< 1KBï¼‰
- **ç½‘ç»œå»¶è¿Ÿ**: ç½‘ç»œéœ‡è¡ä¼šå¯¼è‡´ 150ms çš„çŸ­æš‚ä¸­æ–­ï¼Œä½†ç”¨æˆ·æ— æ„ŸçŸ¥

## å·²çŸ¥é™åˆ¶

1. **æç«¯å¿«é€Ÿæ“ä½œ**: å¦‚æœç”¨æˆ·åœ¨å±å¹•å¼€å¯å **800ms å†…**ç«‹å³ä½¿ç”¨åº”ç”¨ï¼Œå¯èƒ½ä»ä¼šé‡åˆ°çŸ­æš‚å»¶è¿Ÿï¼ˆç­‰å¾…å¥åº·æ£€æŸ¥å®Œæˆï¼‰
2. **Android 5.0 ä»¥ä¸‹**: `setUnderlyingNetworks()` ä¸å¯ç”¨ï¼Œé™çº§ä¸ºåªè°ƒç”¨ `wake()`
3. **éƒ¨åˆ†è€æ—§åº”ç”¨**: ä¸å“åº” `NetworkCallback.onLost()` çš„åº”ç”¨å¯èƒ½ä»éœ€æ‰‹åŠ¨é‡è¿

## åç»­ä¼˜åŒ–æ–¹å‘

1. **åŠ¨æ€è°ƒæ•´æ£€æŸ¥å»¶è¿Ÿ**: æ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´å±å¹•å¼€å¯åçš„æ£€æŸ¥å»¶è¿Ÿï¼ˆå½“å‰å›ºå®š 800msï¼‰
2. **æ™ºèƒ½é˜²æŠ–ä¼˜åŒ–**: è®°å½•ç”¨æˆ·ä½¿ç”¨æ¨¡å¼ï¼Œåœ¨é¢‘ç¹æ“ä½œæ—¶é™ä½æ£€æŸ¥é¢‘ç‡
3. **æ·»åŠ ç”¨æˆ·è®¾ç½®**: å…è®¸ç”¨æˆ·åœ¨è®¾ç½®ä¸­å¯ç”¨/ç¦ç”¨"æ¿€è¿›æ¢å¤æ¨¡å¼"

---

**ä¿®å¤ç‰ˆæœ¬**: v2.1.0
**ä¿®å¤æ—¥æœŸ**: 2026-01-09
**æµ‹è¯•çŠ¶æ€**: âœ… ä»£ç å®ç°å®Œæˆï¼Œå¾…çœŸæœºéªŒè¯
**å‚è€ƒé¡¹ç›®**: NekoBox for Android, sing-box libbox
